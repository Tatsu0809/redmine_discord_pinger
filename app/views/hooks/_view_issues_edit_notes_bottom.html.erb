<% if User.current.allowed_to?(:audit_discord, @project) %>
  <div id="discord-pinger-source" style="display:none;">
    <a href="#" id="send-to-discord-btn" class="icon icon-comment" onclick="return false;">
    </a>
  </div>
<% end %>
<script>
$(document).ready(function() {
  var btn = $('#send-to-discord-btn');
  var btn_html = '<%= sprite_icon(:comment) %>\n<span class="icon-label">Audit</span>\n'
  var editBtn = $('.contextual .icon-edit').first();
  var targetArea = $('.contextual').first();

  btn.append(btn_html);

  if (editBtn.length) {
    editBtn.before(btn);
  } else if (targetArea.length) {
    targetArea.prepend(btn);
  } else {
    $('#discord-pinger-source').show();
  }

  btn.click(function(e) {
    e.preventDefault();
    
    if (btn.hasClass('disabled')) return;

    var issueId = '<%= @issue.try(:id) %>';
    var sending_html = '<%= sprite_icon(:comment) %>\n<span class="icon-label">送信中...</span>\n'
    var success_html = '<%= sprite_icon(:comment) %>\n<span class="icon-label">送信完了</span>\n'

    if (!issueId) return;

    btn.addClass('disabled');
    btn.html(sending_html);
    btn.css('pointer-events', 'none');

    $.ajax({
      url: '/discord_pinger/send',
      type: 'POST',
      data: { issue_id: issueId },
      headers: {
        'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
      },
      success: function(response) {
        btn.html(success_html);
        setTimeout(function() { 
          btn.html(btn_html);
          btn.removeClass('disabled');
          btn.css('pointer-events', 'auto');
        }, 2000);
      },
      error: function(xhr) {
        alert('送信失敗: ' + (xhr.responseJSON ? xhr.responseJSON.message : 'Unknown Error'));
        btn.html(btn_html);
        btn.removeClass('disabled');
        btn.css('pointer-events', 'auto');
      }
    });
  });
});
</script>
